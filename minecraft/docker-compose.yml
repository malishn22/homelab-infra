services:
  minecraft-api:
    build:
      context: ../..
      dockerfile: ./infra/minecraft/backend/Dockerfile
    container_name: minecraft-api
    env_file:
      - ./.env
      - ../../apps/minecraft/backend/.env
    environment:
      UVICORN_RELOAD: "false"
      UVICORN_HOST: 0.0.0.0
      UVICORN_PORT: ${MINECRAFT_API_PORT}
      DATABASE_URL: postgresql://${MINECRAFT_DB_USER}:${MINECRAFT_DB_PASSWORD}@${MINECRAFT_DB_HOST}:${MINECRAFT_DB_PORT}/${MINECRAFT_DB_NAME}
      CONTAINER_DATA_ROOT: /data
      HOST_SERVERS_ROOT: /home/mali/homelab/apps/minecraft/backend/data/servers
    volumes:
      - ../../apps/minecraft/backend/data/instances:/data/instances
      - ../../apps/minecraft/backend/data/servers:/data/servers
      - ../../apps/minecraft/backend/data/server-defaults.properties:/data/server-defaults.properties
      - ../../apps/minecraft/backend/data/whitelist-defaults.json:/data/whitelist-defaults.json
      - ../../apps/minecraft/backend/data/ops-defaults.json:/data/ops-defaults.json
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "${MINECRAFT_API_PORT}:${MINECRAFT_API_PORT}"
    depends_on:
      - minecraft-db
    networks:
      - homelab
    restart: unless-stopped

  minecraft-web:
    build:
      context: ../..
      dockerfile: ./infra/minecraft/frontend/Dockerfile
      args:
        VITE_API_BASE_URL: ""
    container_name: minecraft-web
    depends_on:
      - minecraft-api
    env_file:
      - ./.env
    ports:
      - "${MINECRAFT_WEB_PORT}:${MINECRAFT_WEB_INTERNAL_PORT}"
    networks:
      - homelab
    restart: unless-stopped

  minecraft-db:
    image: postgres:16-alpine
    container_name: ${MINECRAFT_DB_HOST}
    hostname: ${MINECRAFT_DB_HOST}
    environment:
      POSTGRES_DB: ${MINECRAFT_DB_NAME}
      POSTGRES_USER: ${MINECRAFT_DB_USER}
      POSTGRES_PASSWORD: ${MINECRAFT_DB_PASSWORD}
    volumes:
      - minecraft-db-data:/var/lib/postgresql/data
    networks:
      homelab:
        aliases:
          - ${MINECRAFT_DB_HOST}
    restart: unless-stopped

networks:
  homelab:
    external: true
    name: homelab

volumes:
  minecraft-db-data: {}
